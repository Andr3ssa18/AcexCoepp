<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal do Estagi√°rio - Psicologia</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{url_for('static', filename='css/aba_estagiario.css') }}">
</head>
<body>
    <header>
        <div class="logo">
            <span style="font-family: 'Times New Roman', Times, serif;">F</span>
            <span style="font-family: 'Times New Roman', Times, serif;">S</span>
            <span style="font-family: 'Times New Roman', Times, serif;">A</span>
        </div>
        <div class="title" id="page-title">Portal do Estagi√°rio</div>
        <div class="profile" onclick="toggleDropdown()">
            <div>Ol√°, {{ estagiario.nome }}</div>
            <span>{{ estagiario.nome[:1] if estagiario and estagiario.nome else 'E' }}</span>
            <div class="dropdown" id="dropdownMenu">
                <a href="#" onclick="mostrarPagina('pagina-meus-dados')"><span>üë§</span>Minha Conta</a>
                <a href="#" onclick="mostrarPagina('pagina-ajuda')"><span>‚ùì</span>Ajuda</a>
                <a href="#" onclick="logout()"><span>‚Ü©Ô∏è</span>Deslogar</a>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-user">
                    <div class="user-avatar">{{ estagiario.nome[:1] if estagiario and estagiario.nome else 'E' }}</div>
                    <div class="user-info">
                        <div class="user-name">{{ estagiario.nome }}</div>
                        <div class="user-role">RA: {{ estagiario.RA }}</div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" onclick="mostrarPagina('pagina-minhas-consultas')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="nav-icon">
                        <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM5 5v1h14V5H5z"/>
                    </svg>
                    <span>Minhas Consultas</span>
                </a>
                <a href="#" class="nav-item" onclick="mostrarPagina('pagina-meus-horarios')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="nav-icon">
                        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                    </svg>
                    <span>Meus Hor√°rios</span>
                </a>
                <a href="#" class="nav-item" onclick="mostrarPagina('pagina-solicitacoes')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="nav-icon">
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/>
                    </svg>
                    <span>Solicita√ß√µes</span>
                </a>
                <a href="#" class="nav-item" onclick="mostrarPagina('pagina-prontuarios')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="nav-icon">
                        <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/>
                    </svg>
                    <span>Prontu√°rios</span>
                </a>
                <a href="#" class="nav-item" onclick="mostrarPagina('pagina-comunicados')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="nav-icon">
                        <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>
                    </svg>
                    <span>Comunicados</span>
                </a>

                <a href="#" class="nav-item logout" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="nav-icon">
                        <path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/>
                    </svg>
                    <span>Deslogar</span>
                </a>
            </nav>
        </div>

        <div class="content">
            <!-- P√°gina de Minhas Consultas -->
            <div id="pagina-minhas-consultas" class="page active">
                <div class="page-header">
                    <h1>Minhas Consultas</h1>
                </div>
                <div class="page-content">
                    <div class="info-box">
                        <p>Visualize e gerencie suas consultas do dia.</p>
                    </div>
                    
                    <div class="consultas-dia">
                        <h3>Consultas do dia</h3>
                        <div class="info-message"><p>Carregando suas consultas...</p></div>
                    </div>
                </div>
            </div>

            <!-- P√°gina de Meus Hor√°rios -->
            <div id="pagina-meus-horarios" class="page">
                <div class="page-header">
                    <h1>Meus Hor√°rios</h1>
                </div>
                <div class="page-content">
                    <div class="info-box">
                        <p>Informe seus hor√°rios dispon√≠veis</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Dias da Semana</h2>
                        </div>
                        <div class="card-content">
                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    <input type="checkbox" name="dia" value="Segunda">
                                    <span class="checkmark"></span>
                                    Segunda
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="dia" value="Ter√ßa">
                                    <span class="checkmark"></span>
                                    Ter√ßa
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="dia" value="Quarta">
                                    <span class="checkmark"></span>
                                    Quarta
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="dia" value="Quinta">
                                    <span class="checkmark"></span>
                                    Quinta
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="dia" value="Sexta">
                                    <span class="checkmark"></span>
                                    Sexta
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="dia" value="S√°bado">
                                    <span class="checkmark"></span>
                                    S√°bado
                                </label>
                            </div>
                            <button class="btn btn-primary btn-block" id="btn-todos-dias">Todos</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Per√≠odo do dia</h2>
                        </div>
                        <div class="card-content">
                            <div class="checkbox-group">
                                <label class="checkbox-container">
                                    <input type="checkbox" name="periodo" value="Manh√£">
                                    <span class="checkmark"></span>
                                    Manh√£
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="periodo" value="Tarde" checked>
                                    <span class="checkmark"></span>
                                    Tarde
                                </label>
                                <label class="checkbox-container">
                                    <input type="checkbox" name="periodo" value="Noite">
                                    <span class="checkmark"></span>
                                    Noite
                                </label>
                            </div>
                            <button class="btn btn-primary btn-block" id="btn-todos-periodos">Todos</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Hor√°rio espec√≠fico?</h2>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Ex: 14:00 √†s 16:00" maxlength="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-message">
                        <p>Escolha os dias e per√≠odos em que voc√™ pode atender pacientes para triagem. Essas informa√ß√µes ser√£o utilizadas pela equipe da COEPP para atribuir atendimentos.</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary btn-lg" id="btn-salvar-disponibilidade">Salvar Disponibilidade</button>
                    </div>
                </div>
            </div>

            <!-- P√°gina de Solicita√ß√µes de Triagem -->
            <div id="pagina-solicitacoes" class="page">
                <div class="page-header">
                    <h1>Solicita√ß√µes de Triagem</h1>
                </div>
                <div class="page-content">
                    <div class="info-box">
                        <p>Com base nos seus hor√°rios, abaixo est√£o os pacientes que aguardam ser atendidos por voc√™. Analise os hor√°rios dispon√≠veis e confirme se pode atend√™-los.</p>
                    </div>
                    
                    <div class="solicitacoes-list">
                        <!-- As solicita√ß√µes ser√£o carregadas dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- P√°gina de Minha Conta -->
            <div id="pagina-meus-dados" class="page">
                <div class="page-header">
                    <h1>Minha Conta</h1>
                </div>
                <div class="page-content">
                    <div class="info-box">
                        <p>Gerencie suas informa√ß√µes pessoais e configura√ß√µes da conta</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>Informa√ß√µes Pessoais</h2>
                        </div>
                        <div class="card-content">
                            <form id="form-dados-pessoais">
                                <div class="form-group">
                                    <label>Nome Completo</label>
                                    <input type="text" class="form-control" value="Estagi√°rio" readonly>
                                </div>
                                <div class="form-group">
                                    <label>E-mail FSA</label>
                                    <input type="email" class="form-control" value="{{ estagiario.emailfsa }}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>RA</label>
                                    <input type="text" class="form-control" value="{{ estagiario.RA }}" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Curso e Per√≠odo</label>
                                    <input type="text" class="form-control" value="{{ estagiario.curso_periodo }}" readonly>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Informa√ß√µes de Contato</h2>
                        </div>
                        <div class="card-content">
                            <form id="form-contato">
                                <div class="form-group">
                                    <label>Telefone</label>
                                    <input type="tel" class="form-control" value="{{ estagiario.telefone_aluno }}" id="telefone" oninput="formatarTelefone(this)" maxlength="15">
                                </div>
                                <div class="form-group">
                                    <label>E-mail Pessoal</label>
                                    <input type="email" class="form-control" value="" id="email" maxlength="100">
                                </div>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary" onclick="atualizarDadosContato()">Salvar Altera√ß√µes</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2>Alterar Senha</h2>
                        </div>
                        <div class="card-content">
                            <form id="form-senha">
                                <div class="form-group">
                                    <label>Senha Atual</label>
                                    <input type="password" class="form-control" id="senha-atual" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label>Nova Senha</label>
                                    <input type="password" class="form-control" id="nova-senha" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label>Confirmar Nova Senha</label>
                                    <input type="password" class="form-control" id="confirmar-senha" maxlength="20">
                                </div>
                                <div class="action-buttons">
                                    <button type="button" class="btn btn-primary" onclick="alterarSenha()">Alterar Senha</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P√°gina de Prontu√°rios -->
            <div id="pagina-prontuarios" class="page">
                <div class="page-header">
                    <h1>Prontu√°rios</h1>
                </div>
                <div class="page-content">
                    <div class="search-box">
                        <input type="text" placeholder="Buscar paciente..." class="search-input">
                        <button class="btn btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20">
                                <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="prontuarios-list">
                        <!-- Os prontu√°rios ser√£o carregados dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- P√°gina de Comunicados -->
            <div id="pagina-comunicados" class="page">
                <div class="page-header">
                    <h1>Comunicados</h1>
                </div>
                <div class="page-content">
                    <div class="comunicados-list">
                        {% if notificacoes and notificacoes|length > 0 %}
                            {% for n in notificacoes %}
                            <div class="comunicado-item">
                                <div class="comunicado-header">
                                    <div class="comunicado-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                            <path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 9h-2V5h2v6zm0 4h-2v-2h2v2z"/>
                                        </svg>
                                    </div>
                                    <div class="comunicado-info">
                                        <h3>{{ n.titulo }}</h3>
                                        <p class="comunicado-date">{{ n.data_criacao.strftime('%d/%m/%Y %H:%M') }}</p>
                                    </div>
                                </div>
                                <div class="comunicado-content">
                                    <p>{{ n.mensagem }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="info-message"><p>N√£o h√° comunicados no momento.</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- P√°gina de Ajuda -->
            <div id="pagina-ajuda" class="page">
                <div class="page-header">
                    <h1>Ajuda</h1>
                </div>
                <div class="page-content ajuda-content">
                    <div class="info-box">
                        <p>Confira abaixo as perguntas mais comuns e suas respostas.</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2>üìù Acesso e Cadastro</h2>
                        </div>
                        <div class="card-content">
                            <ul style="list-style: none; padding: 0;">
                                <li style="margin-bottom: 1rem;">
                                    <strong>Como fa√ßo meu primeiro acesso?</strong><br>
                                    <span>O coordenador do COEPP enviar√° suas credenciais por e-mail. Use seu e-mail FSA e a senha fornecida para fazer login.</span>
                                </li>
                                <li style="margin-bottom: 1rem;">
                                    <strong>Esqueci minha senha. O que devo fazer?</strong><br>
                                    <span>Entre em contato com o coordenador do COEPP para redefini√ß√£o de senha.</span>
                                </li>
                                <li>
                                    <strong>Posso alterar meus dados de cadastro?</strong><br>
                                    <span>Sim, acesse "Minha Conta" no menu do perfil para atualizar suas informa√ß√µes de contato.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                    
    <!-- Modal de Finaliza√ß√£o de Consulta -->
    <div id="modal-finalizar-consulta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Finalizar Consulta</h2>
                        </div>
            <div class="modal-body">
                            <div class="form-group">
                    <label>Observa√ß√µes da Consulta:</label>
                    <textarea class="form-control" rows="4" placeholder="Adicione observa√ß√µes sobre a consulta..."></textarea>
                </div>
                <div class="form-group">
                    <label>Pr√≥xima Consulta Recomendada:</label>
                                <select class="form-control">
                        <option value="">Selecione o intervalo</option>
                        <option value="7">1 semana</option>
                        <option value="14">2 semanas</option>
                        <option value="21">3 semanas</option>
                        <option value="30">1 m√™s</option>
                        <option value="60">2 meses</option>
                        <option value="90">3 meses</option>
                                </select>
                            </div>
                        </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="fecharModalFinalizarConsulta()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarFinalizacaoConsulta()">Finalizar Consulta</button>
                    </div>
                        </div>
                    </div>
                    
    <!-- Modal de Prontu√°rio Completo -->
    <div id="modal-prontuario" class="modal">
        <div class="modal-content modal-prontuario-completo">
            <div class="modal-header">
                <h2>Prontu√°rio da Consulta</h2>
                        </div>
            <div class="modal-body">
                <input type="hidden" id="prontuario-consulta-id" value="">
                <!-- Informa√ß√µes Gerais -->
                <div class="prontuario-section">
                    <h3 class="section-title">Informa√ß√µes Gerais</h3>
                    <div class="info-row">
                            <div class="form-group">
                            <label for="tipo-triagem">Tipo de Triagem:</label>
                            <select id="tipo-triagem" class="form-control">
                                <option value="primeira-vez">Primeira Vez</option>
                                <option value="retorno">Retorno</option>
                                <option value="urgencia">Urg√™ncia</option>
                                <option value="acompanhamento">Acompanhamento</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sala-atendimento">Sala de Atendimento:</label>
                            <select id="sala-atendimento" class="form-control">
                                <option value="sala-01">Sala 01 - COEPP</option>
                                <option value="sala-02">Sala 02 - COEPP</option>
                                <option value="sala-03">Sala 03 - COEPP</option>
                                <option value="sala-04">Sala 04 - COEPP</option>
                                <option value="sala-05">Sala 05 - COEPP</option>
                            </select>
                            </div>
                        </div>
                    </div>
                    
                <!-- Queixa Principal -->
                <div class="prontuario-section">
                    <h3 class="section-title">Queixa Principal</h3>
                    <div class="form-group">
                        <textarea id="prontuario-queixa" class="form-control" rows="4" placeholder="Descreva detalhadamente a queixa principal apresentada pelo paciente..." required></textarea>
                </div>
            </div>

                <!-- Hist√≥rico do Paciente -->
                <div class="prontuario-section">
                    <h3 class="section-title">Hist√≥rico do Paciente</h3>
                    <div class="form-group">
                        <textarea id="prontuario-historico" class="form-control" rows="5" placeholder="Descreva o hist√≥rico cl√≠nico do paciente, tratamentos anteriores, medica√ß√µes, etc..." required></textarea>
        </div>
    </div>

                <!-- Avalia√ß√£o Inicial -->
                <div class="prontuario-section">
                    <h3 class="section-title">Avalia√ß√£o Inicial</h3>
                <div class="form-group">
                        <textarea id="prontuario-avaliacao" class="form-control" rows="4" placeholder="Descreva suas observa√ß√µes e avalia√ß√£o inicial do paciente durante a consulta..." required></textarea>
                    </div>
                </div>
                
                <!-- Encaminhamentos -->
                <div class="prontuario-section">
                    <h3 class="section-title">Encaminhamentos</h3>
                <div class="form-group">
                        <label for="tipo-encaminhamento">Tipo de Encaminhamento:</label>
                        <select id="tipo-encaminhamento" class="form-control">
                            <option value="sem-encaminhamento">Sem Encaminhamento</option>
                            <option value="psicodiagnostico">Psicodiagn√≥stico</option>
                            <option value="psicoterapia">Psicoterapia</option>
                            <option value="avaliacao-psiquiatrica">Avalia√ß√£o Psiqui√°trica</option>
                            <option value="medico-clinico">M√©dico Cl√≠nico</option>
                            <option value="servico-social">Servi√ßo Social</option>
                            <option value="outro">Outro</option>
                        </select>
                </div>
                <div class="form-group">
                        <textarea id="prontuario-encaminhamento" class="form-control" rows="3" placeholder="Descreva detalhes do encaminhamento, se necess√°rio..."></textarea>
                </div>
            </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="solicitarReajustes()">Solicitar Reajustes</button>
                <button class="btn btn-primary" onclick="aprovarProntuario()">Aprovar Prontu√°rio para Enviar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Solicita√ß√£o de Reajustes -->
    <div id="modal-reajustes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Solicitar Reajustes do Prontu√°rio</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="feedback-reajustes">Feedback/Coment√°rios:</label>
                    <textarea id="feedback-reajustes" class="form-control" rows="4" placeholder="Detalhar melhor o hist√≥rico do paciente ou Corrigir a descri√ß√£o da queixa principal..."></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notificar-email"> Notificar o estagi√°rio por e-mail sobre o reajuste.
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="fecharModalReajustes()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarReajustes()">Confirmar Solicita√ß√£o</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Triagem (novo) -->
    <div id="modal-confirmar-triagem" class="modal modal-confirmar-triagem">
        <div class="modal-content">
            <div class="triagem-header">
                <h2 id="triagem-titulo">Confirmar Triagem</h2>
            </div>
            <div class="triagem-body">
                <div>
                    <span class="triagem-label">Paciente</span>
                    <div id="triagem-paciente" style="font-weight:600; color:#2d3748;">‚Äî</div>
                </div>
                <div class="triagem-row">
                    <div>
                        <label class="triagem-label" for="triagem-data">Data</label>
                        <input id="triagem-data" type="date" class="triagem-input">
                    </div>
                    <div>
                        <label class="triagem-label" for="triagem-hora">Hora</label>
                        <input id="triagem-hora" type="time" class="triagem-input">
                    </div>
                </div>
                <div>
                    <label class="triagem-label" for="triagem-observacoes">Observa√ß√µes (opcional)</label>
                    <textarea id="triagem-observacoes" class="triagem-textarea" rows="3" placeholder="Ex.: Triagem confirmada, trazer exames..."></textarea>
                </div>
                <div class="info-message"><p>Defina a data e hor√°rio para confirmar esta triagem. Um email de confirma√ß√£o √© enviado ao paciente.</p></div>
            </div>
            <div class="triagem-footer">
                <button class="btn btn-outline" onclick="fecharModalConfirmacaoTriagem()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmarTriagemSubmit()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Vari√°vel global para armazenar o ID da consulta atual
        let consultaAtual = null;

        // Fun√ß√£o para alternar o menu dropdown
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Estado do modal de confirma√ß√£o de triagem
        let solicitacaoTriagemAtual = null;

        function abrirModalConfirmacaoTriagem(solicitacaoId, pacienteNome) {
            solicitacaoTriagemAtual = solicitacaoId;
            document.getElementById('triagem-paciente').textContent = pacienteNome || 'Paciente';
            const dataEl = document.getElementById('triagem-data');
            const horaEl = document.getElementById('triagem-hora');
            const obsEl = document.getElementById('triagem-observacoes');
            // Limpa valores anteriores
            dataEl.value = '';
            horaEl.value = '';
            obsEl.value = '';
            // Define a data m√≠nima como hoje
            const hoje = new Date();
            const yyyy = hoje.getFullYear();
            const mm = String(hoje.getMonth() + 1).padStart(2, '0');
            const dd = String(hoje.getDate()).padStart(2, '0');
            dataEl.min = `${yyyy}-${mm}-${dd}`;
            document.getElementById('modal-confirmar-triagem').classList.add('show');
        }

        function fecharModalConfirmacaoTriagem() {
            document.getElementById('modal-confirmar-triagem').classList.remove('show');
            solicitacaoTriagemAtual = null;
        }

        async function confirmarTriagemSubmit() {
            const data = document.getElementById('triagem-data').value;
            const hora = document.getElementById('triagem-hora').value;
            const observacoes = document.getElementById('triagem-observacoes').value || '';
            if (!data) { mostrarToast('Selecione a data da consulta'); return; }
            if (!hora) { mostrarToast('Selecione o hor√°rio da consulta'); return; }
            if (!solicitacaoTriagemAtual) { mostrarToast('Solicita√ß√£o inv√°lida'); return; }
            try {
                const dataAgendamento = `${data}T${hora}`;
                const resp = await fetch(`/api/estagiario/agendamentos/confirmar/${solicitacaoTriagemAtual}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data_agendamento: dataAgendamento, observacoes })
                });
                const json = await resp.json();
                if (!resp.ok) throw new Error(json.error || 'Erro ao confirmar triagem');
                fecharModalConfirmacaoTriagem();
                mostrarToast('Triagem confirmada com sucesso!');
                try { carregarSolicitacoes(); } catch (e) {}
                try { carregarConsultas(); } catch (e) {}
            } catch (e) {
                mostrarToast(e.message || 'Erro ao confirmar triagem');
            }
        }

        // Fun√ß√£o para mostrar uma p√°gina espec√≠fica
        function mostrarPagina(paginaId) {
            // Esconder todas as p√°ginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remover classe active de todos os itens de navega√ß√£o
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Mostrar a p√°gina selecionada
            document.getElementById(paginaId).classList.add('active');
            
            // Adicionar classe active ao item de navega√ß√£o correspondente
            const navItem = document.querySelector(`[onclick="mostrarPagina('${paginaId}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Fechar dropdown
            document.getElementById('dropdownMenu').classList.remove('show');
            
            // Atualizar t√≠tulo da p√°gina
            const titulos = {
                'pagina-minhas-consultas': 'Minhas Consultas',
                'pagina-meus-horarios': 'Meus Hor√°rios',
                'pagina-solicitacoes': 'Solicita√ß√µes',
                'pagina-meus-dados': 'Minha Conta',
                'pagina-prontuarios': 'Prontu√°rios',
                'pagina-comunicados': 'Comunicados',
                'pagina-ajuda': 'Ajuda'
            };
            
            document.getElementById('page-title').textContent = titulos[paginaId] || 'Portal do Estagi√°rio';

            // Carregar dados espec√≠ficos da p√°gina
            if (paginaId === 'pagina-solicitacoes') {
                try { if (typeof carregarSolicitacoes === 'function') carregarSolicitacoes(); } catch(e) {}
            }
            if (paginaId === 'pagina-prontuarios') {
                try { if (typeof carregarProntuariosEstagiario === 'function') carregarProntuariosEstagiario(); } catch(e) {}
            }
        }

        // Fun√ß√£o para abrir o modal de finaliza√ß√£o de consulta
        function abrirModalFinalizarConsulta(consultaId) {
            consultaAtual = consultaId;
            document.getElementById('modal-finalizar-consulta').classList.add('show');
        }

        // Fun√ß√£o para fechar o modal de finaliza√ß√£o de consulta
        function fecharModalFinalizarConsulta() {
            document.getElementById('modal-finalizar-consulta').classList.remove('show');
            // N√£o resetar consultaAtual aqui para permitir propaga√ß√£o ao prontu√°rio
        }

        // Fun√ß√£o para confirmar a finaliza√ß√£o da consulta
        function confirmarFinalizacaoConsulta() {
            const consultaIdSelecionada = consultaAtual; // preservar antes de fechar
            const observacoes = document.querySelector('#modal-finalizar-consulta textarea').value;
            const proximaConsulta = document.querySelector('#modal-finalizar-consulta select').value;

            // Fechar modal de finaliza√ß√£o
            fecharModalFinalizarConsulta();
            
            // Abrir imediatamente o modal de prontu√°rio completo
            document.getElementById('modal-prontuario').classList.add('show');
            // Propagar o ID da consulta para o modal de prontu√°rio (fallback)
            const hiddenInput = document.getElementById('prontuario-consulta-id');
            if (hiddenInput) { hiddenInput.value = consultaIdSelecionada || consultaAtual || ''; }

            // Aqui voc√™ pode adicionar a l√≥gica para enviar os dados para o backend
            // Por exemplo:
            // fetch('/api/finalizar-consulta', {
            //     method: 'POST',
            //     body: JSON.stringify({
            //         consultaId: consultaAtual,
            //         observacoes,
            //         proximaConsulta
            //     })
            // });
        }

        // Fun√ß√£o para fechar o modal de prontu√°rio
        function fecharModalProntuario() {
            document.getElementById('modal-prontuario').classList.remove('show');
            // Limpar campos
            document.getElementById('prontuario-queixa').value = '';
            document.getElementById('prontuario-intervencao').value = '';
            document.getElementById('prontuario-recomendacoes').value = '';
        }

        // Fun√ß√£o para salvar o prontu√°rio completo
        async function salvarProntuarioCompleto() {
            const tipoTriagem = document.getElementById('tipo-triagem').value;
            const sala = document.getElementById('sala-atendimento').value;
            const queixa = document.getElementById('prontuario-queixa').value;
            const historico = document.getElementById('prontuario-historico').value;
            const avaliacao = document.getElementById('prontuario-avaliacao').value;
            const tipoEncaminhamento = document.getElementById('tipo-encaminhamento').value;
            const encaminhamento = document.getElementById('prontuario-encaminhamento').value;
            const hiddenId = document.getElementById('prontuario-consulta-id') ? document.getElementById('prontuario-consulta-id').value : '';
            const consultaIdEfetivo = consultaAtual || hiddenId;

            // Valida√ß√£o
            if (!queixa.trim() || !historico.trim() || !avaliacao.trim()) {
                mostrarToast('Por favor, preencha todos os campos obrigat√≥rios do prontu√°rio.');
                return;
            }
            if (!consultaIdEfetivo) {
                mostrarToast('ID da consulta n√£o encontrado. Abra o prontu√°rio a partir da consulta.');
                return;
            }

            // Dados completos do prontu√°rio
            const dadosProntuario = {
                consultaId: consultaIdEfetivo,
                informacoesGerais: {
                    tipoTriagem,
                    sala
                },
                queixaPrincipal: queixa,
                historicoPaciente: historico,
                avaliacaoInicial: avaliacao,
                encaminhamentos: {
                    tipo: tipoEncaminhamento,
                    descricao: encaminhamento
                },
                dataCriacao: new Date().toISOString(),
                estagiario: 'Estagi√°rio',
                status: 'pendente' // pendente, aprovado, reajustes
            };

            try {
                const resp = await fetch('/api/estagiario/prontuarios', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosProntuario)
                });
                const json = await resp.json();
                if (!resp.ok) {
                    throw new Error(json.error || 'Erro ao salvar prontu√°rio');
                }
                // Fechar modal e mostrar sucesso
                fecharModalProntuario();
                mostrarToast('Prontu√°rio salvo com sucesso!');
                // Atualizar a lista de consultas (se houver fun√ß√£o global dispon√≠vel)
                try { if (typeof carregarConsultas === 'function') { carregarConsultas(); } } catch(e) {}
            } catch (e) {
                mostrarToast(e.message || 'Erro ao salvar prontu√°rio');
            }
        }

        // Fun√ß√£o para aprovar prontu√°rio
        async function aprovarProntuario() {
            // Seta status como aprovado e salva
            await salvarProntuarioCompleto();
        }

        // Fun√ß√£o para solicitar reajustes
        function solicitarReajustes() {
            // Primeiro salvar o prontu√°rio
            salvarProntuarioCompleto();
            
            // Abrir modal de reajustes
            document.getElementById('modal-reajustes').classList.add('show');
        }

        // Fun√ß√£o para fechar modal de reajustes
        function fecharModalReajustes() {
            document.getElementById('modal-reajustes').classList.remove('show');
            document.getElementById('feedback-reajustes').value = '';
            document.getElementById('notificar-email').checked = false;
        }

        // Fun√ß√£o para confirmar solicita√ß√£o de reajustes
        function confirmarReajustes() {
            const feedback = document.getElementById('feedback-reajustes').value;
            const notificarEmail = document.getElementById('notificar-email').checked;

            if (!feedback.trim()) {
                mostrarToast('Por favor, adicione um coment√°rio sobre os reajustes necess√°rios.');
                return;
            }

            // Marcar prontu√°rio como com reajustes
            let prontuarios = JSON.parse(localStorage.getItem('prontuarios') || '[]');
            if (prontuarios.length > 0) {
                prontuarios[prontuarios.length - 1].status = 'reajustes';
                prontuarios[prontuarios.length - 1].reajustes = {
                    feedback,
                    notificarEmail,
                    dataSolicitacao: new Date().toISOString()
                };
                localStorage.setItem('prontuarios', JSON.stringify(prontuarios));
            }

            // Enviar para backend (comentado)
            // fetch('/api/solicitar-reajustes', {
            //     method: 'POST',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify({
            //         prontuarioId: prontuarios[prontuarios.length - 1].id,
            //         feedback,
            //         notificarEmail
            //     })
            // });

            fecharModalReajustes();
            mostrarToast('Solicita√ß√£o de reajustes enviada com sucesso!');
        }

        // Fun√ß√£o para fechar o modal de prontu√°rio
        function fecharModalProntuario() {
            document.getElementById('modal-prontuario').classList.remove('show');
            // Limpar campos
            document.getElementById('prontuario-queixa').value = '';
            document.getElementById('prontuario-historico').value = '';
            document.getElementById('prontuario-avaliacao').value = '';
            document.getElementById('prontuario-encaminhamento').value = '';
            document.getElementById('tipo-triagem').value = 'primeira-vez';
            document.getElementById('sala-atendimento').value = 'sala-01';
            document.getElementById('tipo-encaminhamento').value = 'sem-encaminhamento';
        }

        // Fun√ß√£o para mostrar mensagens toast
        function mostrarToast(mensagem) {
            const toast = document.getElementById('toast');
            toast.textContent = mensagem;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Fun√ß√£o para atualizar a lista de consultas (simula√ß√£o)
        async function carregarConsultas() {
            try {
                const resp = await fetch('/api/estagiario/consultas');
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Erro ao carregar consultas');
                atualizarListaConsultasUI(data || []);
            } catch (e) {
                const c = document.querySelector('.consultas-dia');
                if (c) c.innerHTML = `<h3>Consultas do dia</h3><div class="info-message"><p>${e.message}</p></div>`;
            }
        }

        // ===== PRONTU√ÅRIOS DO ESTAGI√ÅRIO =====
        async function carregarProntuariosEstagiario() {
            const lista = document.querySelector('.prontuarios-list');
            if (!lista) return;
            lista.innerHTML = '<div class="info-message"><p>Carregando prontu√°rios...</p></div>';
            try {
                const resp = await fetch('/api/estagiario/prontuarios');
                const dados = await resp.json();
                if (!resp.ok) throw new Error(dados.error || 'Erro ao carregar prontu√°rios');
                if (!dados || dados.length === 0) {
                    lista.innerHTML = '<div class="info-message"><p>Nenhum prontu√°rio encontrado.</p></div>';
                    return;
                }
                lista.innerHTML = dados.map(p => `
                    <div class="card">
                        <div class="card-content">
                            <div style="display:flex; justify-content:space-between; align-items:center; gap:1rem;">
                                <div>
                                    <div style="font-weight:600; color:#2d3748;">${p.paciente_nome || 'Paciente'}</div>
                                    <div style="color:#4a5568; font-size:0.9rem;">Consulta: ${p.data_consulta || '‚Äî'}</div>
                                    ${p.observacoes_estagiario ? `<div style="margin-top:.25rem; color:#4a5568; font-size:0.9rem;"><strong>Obs.:</strong> ${p.observacoes_estagiario}</div>` : ''}
                                </div>
                                <button class="btn btn-outline" onclick="abrirProntuario(${p.id})">Abrir Prontu√°rio</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                lista.innerHTML = `<div class=\"info-message\"><p>${e.message}</p></div>`;
            }
        }
        
        // Abre o modal do prontu√°rio j√° preenchendo o ID oculto
        function abrirProntuario(agendamentoId) {
            consultaAtual = agendamentoId;
            const hiddenInput = document.getElementById('prontuario-consulta-id');
            if (hiddenInput) hiddenInput.value = agendamentoId;
            document.getElementById('modal-prontuario').classList.add('show');
        }

        function atualizarListaConsultasUI(consultas) {
            const container = document.querySelector('.consultas-dia');
            if (!container) return;
            if (!consultas || consultas.length === 0) {
                container.innerHTML = `<h3>Consultas do dia</h3><div class="info-message"><p>Nenhuma consulta encontrada.</p></div>`;
                return;
            }
            let html = `<h3>Consultas do dia</h3>`;
            consultas.forEach(c => {
                const status = c.status || '';
                const dataAg = c.data_agendamento ? c.data_agendamento : null;
                const dataStr = dataAg ? new Date(dataAg).toLocaleDateString('pt-BR') : '‚Äî';
                const horaStr = dataAg ? new Date(dataAg).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '‚Äî';
                html += `
                <div class="card">
                    <div class="card-content">
                        <div style="display:flex; justify-content: space-between; align-items:center; gap:1rem;">
                            <div>
                                <strong>Paciente:</strong> ${c.paciente_nome || 'Paciente'}<br>
                                <strong>Data/Hora:</strong> ${dataStr} ${horaStr}<br>
                                <strong>Status:</strong> <span style="color:#667eea;">${status}</span>
                            </div>
                            ${status === 'confirmado' ? `<button class="btn btn-primary" onclick="abrirModalFinalizarConsulta(${c.id})">Finalizar Consulta</button>` : '<button class="btn btn-outline" disabled>Sem a√ß√µes</button>'}
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        // Carregar Solicita√ß√µes de Triagem para o estagi√°rio
        async function carregarSolicitacoes() {
            const lista = document.querySelector('.solicitacoes-list');
            if (!lista) return;
            lista.innerHTML = '<div class="info-message"><p>Carregando solicita√ß√µes...</p></div>';
            try {
                const resp = await fetch('/api/estagiario/solicitacoes');
                const dados = await resp.json();
                if (!resp.ok) throw new Error(dados.error || 'Erro ao carregar solicita√ß√µes');
                if (!dados || dados.length === 0) {
                    lista.innerHTML = '<div class="info-message"><p>Nenhuma solicita√ß√£o pendente.</p></div>';
                    return;
                }
                lista.innerHTML = dados.map(s => `
                    <div class="comunicado-item" style="border-left-color:#f5c842;">
                        <div class="comunicado-header">
                            <div class="comunicado-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
                                </svg>
                            </div>
                            <div class="comunicado-info">
                                <h3>${s.paciente_nome || 'Paciente'}</h3>
                                <p class="comunicado-date">${s.data_solicitacao || ''}</p>
                            </div>
                        </div>
                        <div class="comunicado-content">
                            <p><strong>Observa√ß√µes:</strong> ${s.observacoes_paciente || 'Nenhuma'}</p>
                            <div class="action-buttons" style="justify-content:flex-start; margin-top:1rem;">
                                <button class="btn btn-primary" onclick="abrirModalConfirmacaoTriagem('${s.id}', '${s.paciente_nome || ''}')">Confirmar Triagem</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                lista.innerHTML = `<div class=\"info-message\"><p>${e.message}</p></div>`;
            }
        }

        // Fluxo direto de confirma√ß√£o (prompts simples)
        async function confirmarTriagemDireta(solicitacaoId, pacienteNome) {
            try {
                const data = prompt(`Defina a DATA da consulta para ${pacienteNome} (YYYY-MM-DD):`);
                if (!data) return;
                const hora = prompt('Defina o HOR√ÅRIO da consulta (HH:MM, 24h):');
                if (!hora) return;
                const observacoes = prompt('Observa√ß√µes (opcional):') || '';
                const dataAgendamento = `${data}T${hora}`;

                const resp = await fetch(`/api/estagiario/agendamentos/confirmar/${solicitacaoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data_agendamento: dataAgendamento, observacoes })
                });
                const json = await resp.json();
                if (!resp.ok) throw new Error(json.error || 'Erro ao confirmar triagem');

                mostrarToast('Triagem confirmada com sucesso!');
                try { carregarSolicitacoes(); } catch(e) {}
                try { carregarConsultas(); } catch(e) {}
            } catch (e) {
                mostrarToast(e.message || 'Erro ao confirmar triagem');
            }
        }

        // Fun√ß√£o para formatar telefone
        function formatarTelefone(input) {
            let valor = input.value.replace(/\D/g, "");
            if (valor.length > 11) valor = valor.slice(0, 11);

            if (valor.length >= 1) {
                valor = `(${valor.slice(0, 2)}) ${valor.slice(2)}`;
            }
            if (valor.length > 10) {
                valor = valor.slice(0, 10) + "-" + valor.slice(10);
            }
            input.value = valor;
        }

        // Fun√ß√£o para logout
        function logout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                // Aqui voc√™ pode adicionar a l√≥gica de logout
                window.location.href = '/login';
            }
        }

        // Fun√ß√£o para atualizar dados de contato
        function atualizarDadosContato() {
            mostrarToast('Dados de contato atualizados com sucesso!');
        }

        // Fun√ß√£o para alterar senha
        function alterarSenha() {
            const senhaAtual = document.getElementById('senha-atual').value;
            const novaSenha = document.getElementById('nova-senha').value;
            const confirmarSenha = document.getElementById('confirmar-senha').value;

            if (novaSenha !== confirmarSenha) {
                mostrarToast('As senhas n√£o coincidem!');
                return;
            }

            mostrarToast('Senha alterada com sucesso!');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Fechar dropdown ao clicar fora
            document.addEventListener('click', function(event) {
                const dropdown = document.getElementById('dropdownMenu');
                const profile = document.querySelector('.profile');
                
                if (!profile.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Fechar modais ao clicar no background
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // Tecla ESC para fechar modais
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });
            // Carregar consultas reais
            carregarConsultas();
        });
    </script>
</body>
</html>
